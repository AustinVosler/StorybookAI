<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>APP NAME</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css') }}">
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}"> -->

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fuzzy+Bubbles:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <img id="bg-img" src="{{ url_for('static', filename='img/background-vector.svg') }}">
    <div class="background">
        <div id="star-animation" class="active"></div>

        <div class="container">
            <div class="text">
                <p style="font-size: 2rem" id="loading-label">Loading...</p>
            </div>
        </div>

    </div>
</body>
</html>

<script>
    const starImages = [
      "{{ url_for('static', filename='img/stars/star-lg.svg') }}",
      "{{ url_for('static', filename='img/stars/star-md.svg') }}",
      "{{ url_for('static', filename='img/stars/star-sm.svg') }}"
    ];

    const starAnimation = document.getElementById('star-animation');

    function spawnStar() {
        if (!starAnimation.classList.contains('active')) return;

        const img = document.createElement('img');
        img.src = starImages[Math.floor(Math.random() * starImages.length)];
        img.className = 'star';

        const size = Math.random() * 30 + 10;
        img.style.width = `${size}px`;
        img.style.height = `${size}px`;

        img.style.top = `${Math.random() * 100}%`;
        img.style.left = `${Math.random() * 100}%`;

        starAnimation.appendChild(img);

        setTimeout(() => starAnimation.removeChild(img), 2000); // match CSS animation duration
    }

    setInterval(() => {
        for (let i = 0; i < 10; i++) spawnStar(); // spawn multiple at once
    }, 300); // adjust interval to control intensity

    const loadingLabel = document.querySelector("#loading-label");
    function loadingLabelLoop(time) {
        loadingLabel.textContent = "Loading."
        setTimeout(()=>{loadingLabel.textContent = "Loading.."}, time/3)
        setTimeout(()=>{loadingLabel.textContent = "Loading..."}, 2*(time/3))
        setTimeout(()=>{loadingLabelLoop(time)}, time)
    }
    loadingLabelLoop(1000);
    setTimeout(()=>{loadingLabel.style.opacity=1},500)

    
    function finish(result) {
        // animate loading label out
        loadingLabel.style.transition = "0.2s ease";
        loadingLabel.style.transform = "scale(0%)";

        // NOW do the star animation
        starAnimation.style.transition = "1s ease";
        starAnimation.style.filter = "brightness(200%) blur(10px)";
    }


    async function checkStatus() {
        console.log("CHECKING STATUS");
        const res = await fetch('/status');
        const json = await res.json();
        if (json.status === "done") {
            console.log("YYYYEEEEEEEESSSSSSSSSSSS");
            finish(json.result);
        } else {
            console.log("nope...");
            setTimeout(checkStatus, 200); // Retry again and again and again
        }
    }

    function startAndWait() {
        fetch('/start').then(() => {
            checkStatus(); // start polling!!
        });
    }
    startAndWait()
</script>